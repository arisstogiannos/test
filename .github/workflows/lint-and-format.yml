name: Lint and Format Code

on:
   push:
      branches: [main]
   pull_request:
      branches: [main]

jobs:
   lint-and-format:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v4
           with:
              token: ${{ secrets.GITHUB_TOKEN }}

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '18'
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Run ESLint and fix issues
           run: npm run lint:fix

         - name: Run Prettier formatting
           run: npm run format

         - name: Check for changes
           id: verify-changed-files
           run: |
              if [ -n "$(git status --porcelain)" ]; then
                 echo "changed=true" >> $GITHUB_OUTPUT
              else
                 echo "changed=false" >> $GITHUB_OUTPUT
              fi

         - name: Pull latest changes and amend commit
           if: steps.verify-changed-files.outputs.changed == 'true'
           run: |
              git config --local user.email "arsenis_sto@yahoo.gr"
              git config --local user.name "arisstogiannos"
              git pull origin main
              git add .
              git commit --amend --no-edit
              git push --force-with-lease origin main
